<!DOCTYPE html>
<html>
	<head>
		<title>Goodbye, Jens</title>
		<meta charset=utf-8>
		<style>
			* {
				color: #202122;
				font-weight: bold;
			}

			body {
				margin-inline: auto; /* horizontally center the <article> */
				max-inline-size: max-content;
				overflow-block: auto;
			}

			#background {
				object-fit: cover;
				object-position: center;
				background-color: #a2a9b1; /* to avoid a glaring white while the background-image hasn’t loaded */
				position: fixed;
				width: 100vw; /* use vw/vh, rather than 100%, to not be affected by <body>’s scrollbar, if any */
				height: 100vh;
				inset: 0;
				z-index: -1;
			}

			article {
				display: flex;
				flex-direction: column;
				justify-content: space-between; /* space between <main> and <footer> */
				margin: 40px;
				padding: 16px;
				box-sizing: border-box;
				min-block-size: calc(100vh - 2*40px); /* TODO vh with -block- doesn’t make sense (the solution would be vb but not even Firefox supports that) */
				max-inline-size: 688px;
				background: rgba(255, 255, 255, 75%);
			}

			h1 {
				margin-block: 0 8px;
				font-size: 36px;
				line-height: 42px;
			}

			p {
				margin-block: 0;
				font-size: 16px;
				line-height: 21px;
			}

			button.primary {
				display: block;
				margin-block: 40px;
				margin-inline: auto;
				padding-block: 10px;
				padding-inline: 17px;
				font-size: 16px;
				line-height: 20px;
				color: #fff;
				background-color: #36C;
				border: none;
				cursor: pointer;
			}

			blockquote {
				margin: 24px;
				text-align: center;
			}

			blockquote > * {
				background: #fff;
			}

			figure {
				background: #fff;
				margin-block: 24px;
				margin-inline: 0;
				line-height: 0;
			}

			figure img,
			figure video {
				max-inline-size: 100%;
				block-size: auto;
			}

			figure.audio {
				padding-block: 24px;
			}

			button.play {
				display: block;
				inline-size: 120px;
				block-size: 120px;
				margin-block-start: 16px;
				margin-inline: auto;
				background: url("Toicon-icon-fandom-play.svg") center/100%;
				border: none;
				cursor: pointer;
				transition: inline-size 50ms, block-size, margin-block-start, margin-block-end;
			}

			button.play:active {
				inline-size: 104px;
				block-size: 104px;
				margin-block-start: calc(16px + (120px - 104px)/2);
				margin-block-end: calc((120px - 104px)/2); /* so the whole button still has the same block size */
			}

			.author {
				font-style: italic;
			}

			footer p,
			footer p * {
				font-weight: normal;
				text-align: end;
				font-size: 12px;
				line-height: 16px;
			}

			footer div { /* sometimes the extmetadata contains <div>s */
				display: inline-block;
			}
		</style>
	</head>
	<body>
		<img id=background alt="">
		<article>
			<main>
				<h1>Dear Jens,</h1>
				<p>
					we miss you.
					For the moments where you feel the same,
					we’ve collected a bunch of kind words for you to retrieve.
					Click the blue button for a small portion of sunshine.
				</p>
				<button type=button id=complimentButton class=primary>
					Get a compliment
				</button>
				<blockquote id=complimentContainer>
					<!-- filled by JavaScript -->
				</blockquote>
			</main>
			<footer>
				<p>
					Background image:
					<span id=attributionPictureOfTheDay>loading…</span>
				</p>
				<p>
					Play button:
					Carol Liao/toicon.com,
					<a href="https://commons.wikimedia.org/wiki/File:Toicon-icon-fandom-play.svg">Toicon-icon-fandom-play.svg</a>,
					<a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>,
					via Wikimedia Commons
				</p>
			</footer>
		</article>
		<script>
			'use strict';

			async function pictureOfTheDay() {
				const date = new Date();
				const wikitext = `{{Potd/${date.toISOString().substring(0, 10)}}}`;
				const url = new URL('https://commons.wikimedia.org/w/api.php');
				url.searchParams.set('action', 'parse');
				url.searchParams.set('text', wikitext);
				url.searchParams.set('contentmodel', 'wikitext');
				url.searchParams.set('prop', 'text');
				url.searchParams.set('wrapoutputclass', '');
				url.searchParams.set('disablelimitreport', '');
				url.searchParams.set('format', 'json');
				url.searchParams.set('formatversion', '2');
				url.searchParams.set('origin', '*');
				try {
					const response = await fetch(url);
					const { parse: { text: html } } = await response.json();
					return html.replace(/^<p>([^]*)\n<\/p>$/, '$1').replace(/ /g, '_');
				} catch (e) {
					console.error('Could not load picture of the day:', e);
					return null;
				}
			}

			async function getAttributionAndSize(fileTitle) {
				const filePage = `https://commons.wikimedia.org/wiki/File:${encodeURIComponent(fileTitle)}`;
				const url = new URL('https://commons.wikimedia.org/w/api.php');
				url.searchParams.set('action', 'query');
				url.searchParams.set('titles', `File:${fileTitle}`);
				url.searchParams.set('prop', 'imageinfo');
				url.searchParams.set('iiprop', ['extmetadata', 'size'].join('|'));
				url.searchParams.set('iiextmetadatafilter', ['Artist', 'ObjectName', 'LicenseShortName', 'LicenseUrl'].join('|'));
				url.searchParams.set('format', 'json');
				url.searchParams.set('formatversion', '2');
				url.searchParams.set('origin', '*');
				let attributionHtml, width, height;
				try {
					const response = await fetch(url);
					const { query: { pages: [ { imageinfo: [ imageinfo ] } ] } } = await response.json();
					const { extmetadata } = imageinfo;
					({ width, height } = imageinfo);
					const { Artist, ObjectName, LicenseShortName, LicenseUrl } = extmetadata;
					const license = LicenseUrl // undefined for public domain files
						? `<a href="${LicenseUrl.value}">${LicenseShortName.value}</a>`
						: LicenseShortName.value;
					attributionHtml = `${Artist.value},
<a href="${filePage}">${ObjectName.value}</a>,
${license},
via Wikimedia Commons`;
				} catch (e) {
					console.error('Could not get proper attribution:', e);
					attributionHtml = `<a href="${filePage}">${fileTitle}</a>`;
				}
				return { attributionHtml, width, height };
			}

			async function loadBackground() {
				const fileTitle = await pictureOfTheDay();
				if (!fileTitle) {
					document.getElementById('attributionPictureOfTheDay').textContent = 'error';
					return;
				}

				const { attributionHtml, width, height } = await getAttributionAndSize(fileTitle);
				const backgroundImg = document.getElementById('background');
				if (width && height) {
					backgroundImg.width = width;
					backgroundImg.height = height;
				}
				backgroundImg.src = `https://commons.wikimedia.org/wiki/Special:Redirect/file/${fileTitle}`;
				backgroundImg.srcset = `
					https://commons.wikimedia.org/wiki/Special:Redirect/file/${fileTitle}?width=320 320w,
					https://commons.wikimedia.org/wiki/Special:Redirect/file/${fileTitle}?width=640 640w,
					https://commons.wikimedia.org/wiki/Special:Redirect/file/${fileTitle}?width=800 800w,
					https://commons.wikimedia.org/wiki/Special:Redirect/file/${fileTitle}?width=1024 1024w,
					https://commons.wikimedia.org/wiki/Special:Redirect/file/${fileTitle}?width=1280 1280w,
					https://commons.wikimedia.org/wiki/Special:Redirect/file/${fileTitle}?width=1920 1920w`;
				document.getElementById('attributionPictureOfTheDay').innerHTML = attributionHtml;
			}

			loadBackground().catch(console.error);

			const compliments = [
				{
					text: 'Here goes the text for a short compliment.',
				},
				{
					text: 'Here goes the text for a very long compliment that spans multiple lines and talks about how great Jens is.',
					image: 'Placeholder.png',
					imageAlt: 'Placeholder',
					imageWidth: 480,
					imageHeight: 480,
				},
				{
					image: 'Placeholder.png',
					imageWidth: 480,
					imageHeight: 480,
					author: 'Test Author',
				},
				{
					audio: 'LL-Q188_(deu)-Sebastian_Wallroth-Beispiel.wav',
					author: 'Test Recorder',
				},
				{
					video: 'Chen-Gackstatter_surface.webm',
					videoWidth: 1080,
					videoHeight: 1080,
				},
			];

			const complimentContainer = document.getElementById('complimentContainer');
			let complimentText = null,
				complimentImageFigure = null,
				complimentImageImg = null,
				complimentAudioFigure = null,
				complimentAudioFigcaption = null,
				complimentAudioFigcaptionP = null,
				complimentAudioButton = null,
				complimentAudioAudio = null,
				complimentVideoFigure = null,
				complimentVideoVideo = null,
				complimentAuthor = null;

			function applyCompliment(compliment) {
				if (compliment.text) {
					if (complimentText === null) {
						complimentText = document.createElement('p');
					} else {
						complimentText.remove();
					}
					complimentContainer.append(complimentText);
					complimentText.textContent = compliment.text;
				} else {
					if (complimentText !== null) {
						complimentText.remove();
						complimentText = null;
					}
				}

				if (compliment.image) {
					if (complimentImageFigure === null) {
						complimentImageFigure = document.createElement('figure');
						complimentImageFigure.classList.add('image');
						complimentImageImg = document.createElement('img');
						complimentImageFigure.append(complimentImageImg);
					} else {
						complimentImageFigure.remove();
					}
					complimentContainer.append(complimentImageFigure);
					complimentImageImg.src = compliment.image;
					updateAttribute(complimentImageImg, 'alt', compliment.imageAlt);
					updateAttribute(complimentImageImg, 'width', compliment.imageWidth);
					updateAttribute(complimentImageImg, 'height', compliment.imageHeight);
				} else {
					if (complimentImageFigure !== null) {
						complimentImageFigure.remove();
						complimentImageFigure = null;
						complimentImageImg = null;
					}
				}

				if (compliment.audio) {
					if (complimentAudioFigure === null) {
						complimentAudioFigure = document.createElement('figure');
						complimentAudioFigure.classList.add('audio');
						complimentAudioFigcaption = document.createElement('figcaption');
						complimentAudioFigcaptionP = document.createElement('p');
						complimentAudioFigcaptionP.textContent = 'Turn up your volume and click me to listen to the compliment.';
						complimentAudioFigcaption.append(complimentAudioFigcaptionP);
						complimentAudioButton = document.createElement('button');
						complimentAudioButton.title = 'Play';
						complimentAudioButton.classList.add('play');
						complimentAudioButton.addEventListener('click', playAudio);
						complimentAudioFigure.append(complimentAudioFigcaption, complimentAudioButton);
					} else {
						complimentAudioFigure.remove();
					}
					complimentContainer.append(complimentAudioFigure);
					complimentAudioAudio = new Audio(compliment.audio);
				} else {
					if (complimentAudioFigure !== null) {
						complimentAudioFigure.remove();
						complimentAudioFigure = null;
						complimentAudioFigcaption = null;
						complimentAudioButton = null;
						complimentAudioAudio.pause();
						complimentAudioAudio = null;
					}
				}

				if (compliment.video) {
					if (complimentVideoFigure === null) {
						complimentVideoFigure = document.createElement('figure');
						complimentVideoFigure.classList.add('video');
						complimentVideoVideo = document.createElement('video');
						complimentVideoVideo.controls = true;
						complimentVideoVideo.preload = true;
						complimentVideoFigure.append(complimentVideoVideo);
					} else {
						complimentVideoFigure.remove();
					}
					complimentContainer.append(complimentVideoFigure);
					complimentVideoVideo.src = compliment.video;
					updateAttribute(complimentVideoVideo, 'width', compliment.videoWidth);
					updateAttribute(complimentVideoVideo, 'height', compliment.videoHeight);
				} else {
					if (complimentVideoFigure !== null) {
						complimentVideoFigure.remove();
						complimentVideoFigure = null;
						complimentVideoVideo = null;
					}
				}

				if (compliment.author) {
					if (complimentAuthor === null) {
						complimentAuthor = document.createElement('p');
						complimentAuthor.classList.add('author');
					} else {
						complimentAuthor.remove();
					}
					complimentContainer.append(complimentAuthor);
					complimentAuthor.textContent = compliment.author;
				} else {
					if (complimentAuthor !== null) {
						complimentAuthor.remove();
						complimentAuthor = null;
					}
				}
			}

			function updateAttribute(element, attribute, value) {
				if (value !== undefined) {
					element.setAttribute(attribute, value);
				} else {
					element.removeAttribute(attribute);
				}
			}

			function playAudio() {
				complimentAudioAudio.play();
			}

			let lastRandomCompliment = null;
			function applyRandomCompliment() {
				let compliment;
				do {
					compliment = compliments[Math.floor(Math.random() * compliments.length)];
				} while (compliment === lastRandomCompliment);
				lastRandomCompliment = compliment;
				applyCompliment(compliment);
			}

			document.getElementById('complimentButton').addEventListener('click', applyRandomCompliment);
			</script>
	</body>
</html>
